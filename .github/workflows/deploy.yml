name: Deploy & Sync Workflows

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      sync_only:
        description: 'Only sync workflows (skip deploy)'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run workflow sync'
        type: boolean
        default: false

env:
  NODE_VERSION: '20'

jobs:
  # Job 1: Lint and Type Check
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Type check
        working-directory: frontend
        run: npm run typecheck

      - name: Lint
        working-directory: frontend
        run: npm run lint

  # Job 2: Sync n8n Workflows
  sync-workflows:
    name: Sync n8n Workflows
    runs-on: ubuntu-latest
    needs: [validate]
    if: ${{ !inputs.sync_only || inputs.sync_only }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Sync workflows to n8n
        env:
          N8N_API_URL: ${{ secrets.N8N_API_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            node scripts/sync-workflows.js --dry-run --verbose
          else
            node scripts/sync-workflows.js --verbose
          fi

  # Job 3: Notify Dokploy (if configured)
  notify-deploy:
    name: Trigger Dokploy Deploy
    runs-on: ubuntu-latest
    needs: [validate, sync-workflows]
    if: ${{ !inputs.sync_only && secrets.DOKPLOY_WEBHOOK_URL != '' }}
    steps:
      - name: Trigger Dokploy deployment
        run: |
          curl -X POST "${{ secrets.DOKPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'
        continue-on-error: true

  # Job 4: Health Check (after deploy)
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [notify-deploy]
    if: ${{ !inputs.sync_only && secrets.DASHBOARD_URL != '' }}
    steps:
      - name: Wait for deployment
        run: sleep 60

      - name: Check dashboard health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.DASHBOARD_URL }}/api/health")
          if [ "$response" = "200" ]; then
            echo "Dashboard is healthy!"
          else
            echo "Dashboard health check failed with status: $response"
            exit 1
          fi
        continue-on-error: true

      - name: Check n8n health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.N8N_API_URL }}/healthz")
          if [ "$response" = "200" ]; then
            echo "n8n is healthy!"
          else
            echo "n8n health check failed with status: $response"
            exit 1
          fi
        continue-on-error: true

  # Job 5: Verify Workflows are Imported
  verify-workflows:
    name: Verify Workflows
    runs-on: ubuntu-latest
    needs: [health-check]
    if: ${{ !inputs.sync_only && secrets.N8N_API_URL != '' && secrets.N8N_API_KEY != '' }}
    steps:
      - name: Wait for workflow import
        run: |
          echo "Waiting for n8n workflow auto-import to complete..."
          sleep 30

      - name: Check workflow availability
        run: |
          response=$(curl -s "${{ secrets.N8N_API_URL }}/api/v1/workflows" \
            -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
            --max-time 30)

          workflow_count=$(echo "$response" | grep -o '"id"' | wc -l)
          echo "Found $workflow_count workflows in n8n"

          if [ "$workflow_count" -ge 5 ]; then
            echo "Workflow import successful!"
          elif [ "$workflow_count" -gt 0 ]; then
            echo "Warning: Only $workflow_count workflows found (expected >= 5)"
            echo "Some workflows may need manual import or credential setup"
          else
            echo "Error: No workflows found - import may have failed"
            echo "Check n8n logs: docker compose logs n8n"
            exit 1
          fi

      - name: Verify critical workflows
        run: |
          response=$(curl -s "${{ secrets.N8N_API_URL }}/api/v1/workflows" \
            -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
            --max-time 30)

          # Check for API workflow (critical for dashboard)
          if echo "$response" | grep -q '"name":"AI Product Factory - API"'; then
            echo "API workflow found"
          else
            echo "Warning: API workflow not found"
          fi

          # Check for Main Orchestrator
          if echo "$response" | grep -q '"name":"AI Product Factory - Main Orchestrator"'; then
            echo "Main Orchestrator workflow found"
          else
            echo "Warning: Main Orchestrator workflow not found"
          fi
        continue-on-error: true
